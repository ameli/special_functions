build_and_store_wheels: &BUILD_AND_STORE_WHEELS
  install_cibuildwheel_script:
    - python -m pip install cibuildwheel
  cibuildwheel_script:
    - cibuildwheel
  wheels_artifacts:
    path: "wheelhouse/*"


# ==============================
# pypi build wheel linux aarch64
# ==============================

pypi_build_wheels_linux_aarch64_task:
  use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true'
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder-arm64
    architecture: arm64
    platform: linux
    cpu: 1
    memory: 4G
  matrix:
    - env:
        CIBW_BUILD: "cp39-manylinux_aarch64"
        # EXPECT_CPU_FEATURES: NEON NEON_FP16 NEON_VFPV4 ASIMD ASIMDHP ASIMDDP ASIMDFHM
    - env:
        CIBW_BUILD: "cp310-manylinux_aarch64"
    - env:
        CIBW_BUILD: "cp311-manylinux_aarch64"
    - env:
        CIBW_BUILD: "cp312-manylinux_aarch64"
  env:
    CIBW_ARCHS: "aarch64"
    # CIBW_BUILD: "*-manylinux_aarch64"
    CIBW_SKIP: "pp37-* cp36-* cp37-* cp38-*"
    CIBW_BUILD_VERBOSITY: "3"
    # CIBW_BEFORE_BUILD: "bash {project}/tools/wheels/cibw_before_build.sh {project}"
    MANYLINUX_AARCH64_IMAGE: "manylinux2014"
    ENVIRONMENT: >
      CFLAGS="-fno-strict-aliasing"
      LDFLAGS="-Wl,--strip-debug"
      RUNNER_OS="Linux"

  build_script: |
    apt update
    apt install -y python3-venv python-is-python3 gfortran libatlas-base-dev libgfortran5 eatmydata
    git fetch origin
    # bash ./tools/wheels/cibw_before_build.sh ${PWD}
    which python
    echo $CIRRUS_CHANGE_MESSAGE
  <<: *BUILD_AND_STORE_WHEELS


# ======================
# pypi upload all wheels
# ======================

pypi_wheels_upload_linux_aarch64_task:
  use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true'
  # Artifacts don't seem to be persistent from task to task.
  # Rather than upload wheels at the end of each cibuildwheel run we do a
  # final upload here. This is because a run may be on different OS for
  # which bash, etc, may not be present.
  depends_on:
    - pypi_build_wheels_linux_aarch64
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder
    platform: linux
    cpu: 1
    memory: 4G

  env:
    PYPI_PASSWORD: ENCRYPTED[485f574e94e67a6d00e46a2490863b7b67059cccaf723e09c1f56af3e8b806627d3391d0a501ef7135a52590a902f7b5]

  upload_script: |
    apt-get update
    apt-get install -y curl wget

    # The name of the zip file is derived from the `wheels_artifact` line.
    # If you change the artifact line to `myfile_artifact` then it would be
    # called myfile.zip
    curl https://api.cirrus-ci.com/v1/artifact/build/$CIRRUS_BUILD_ID/wheels.zip --output wheels.zip
    mkdir -p dist
    unzip -j wheels.zip -d dist

    source ./tools/wheels/upload_wheels.sh
    install_anaconda "linux_x86_64"
    upload_wheels_pypi


# ==================
# test linux aarch64
# ==================

pypi_test_linux_aarch64_task:
  use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true'
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder-arm64
    architecture: arm64
    platform: linux
    cpu: 1
    memory: 4G
  depends_on:
    - pypi_wheels_upload_linux_aarch64

  test_script: |
    apt update
    apt install -y python3
    set -xe
    uname -m
    python3 -c "import platform;print(platform.python_version());print(platform.system());print(platform.machine())"
    python3 -m pip install --upgrade pip
    python3 -m pip install --upgrade special_functions
    python3 -m pip install numpy
    python3 -m pip install -r tests/requirements.txt
    mv special_functions special_functions_do_dot_import
    python3 -m pytest
